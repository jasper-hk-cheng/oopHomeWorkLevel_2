<!--  taken from https://github.com/johan/js-deflate -->
<html>
<head>
    <meta charset="UTF-8">

</head>
<body>
<form>
    <textarea id="inflated" cols="64" rows="16">

        @startuml

        '!include util/commonStyle.puml !commonStyle

        caption ~~ clock and its observer ~~

        class subjectClock{
            -allTheObserver[];
            +registerObserver()
            -onTick()
        }

        class the1stObserverClock{
            +setSubject()
            +setTime()
        }

        class the2ndObserverClock{
            +setSubject()
            +setTime()
        }

        the1stObserverClock "observer" <--o "subject" subjectClock : register observer >
        subjectClock "subject" o--> "observer" the2ndObserverClock : register observer >

        @enduml

    </textarea>
    <p>
        <input type=submit onclick="compress($('inflated').value);return false;">
    <p>
        <img id="im" src=http://www.plantuml.com/plantuml/img/SyfFKj2rKt3CoKnELR1Io4ZDoSa70000>
</form>

</body>

<script src="rawdeflate.js"></script>
<script>
$ = function(id){ return document.getElementById(id) };

function encode64(data) {

    //test
    console.log(data);

	r = "";
	for (i=0; i<data.length; i+=3) {
 		if (i+2==data.length) {
			r +=append3bytes(data.charCodeAt(i), data.charCodeAt(i+1), 0);
		} else if (i+1==data.length) {
			r += append3bytes(data.charCodeAt(i), 0, 0);
		} else {
			r += append3bytes(data.charCodeAt(i), data.charCodeAt(i+1),
				data.charCodeAt(i+2));
		}

		//test
		console.log('i = ' + data.charAt(i) + ' i+1 = ' + data.charAt(i+1) + ' i+2 = ' + data.charAt(i+2));
		console.log('r: ' + i + '~' + (i + 3) + ' -> ' + r);
		console.log('');
	}
	return r;
}

function append3bytes(b1, b2, b3) {

    //test
    console.log('b1 = ' + b1 + ' b2 = ' + b2 + ' b3 = ' + b3);

	c1 = b1 >> 2;
	c2 = ((b1 & 0x3) << 4) | (b2 >> 4);
	c3 = ((b2 & 0xF) << 2) | (b3 >> 6);
	c4 = b3 & 0x3F;
	r = "";
	r += encode6bit(c1 & 0x3F);
	r += encode6bit(c2 & 0x3F);
	r += encode6bit(c3 & 0x3F);
	r += encode6bit(c4 & 0x3F);

    //test
	console.log('append3bytes r = ' + r);

	return r;
}

function encode6bit(b) {
	if (b < 10) {
 		return String.fromCharCode(48 + b);
	}
	b -= 10;
	if (b < 26) {
 		return String.fromCharCode(65 + b);
	}
	b -= 26;
	if (b < 26) {
 		return String.fromCharCode(97 + b);
	}
	b -= 26;
	if (b == 0) {
 		return '-';
	}
	if (b == 1) {
 		return '_';
	}
	return '?';
}

var deflater = window.SharedWorker && new SharedWorker('rawdeflate.js');
if (deflater) {
	deflater.port.addEventListener('message', done_deflating, false);
	deflater.port.start();
} else if (window.Worker) {
	deflater = new Worker('rawdeflate.js');
	deflater.onmessage = done_deflating;
}

function done_deflating(e) {

    var encodeResult = encode64(e.data);

    //test
    console.log(encodeResult)

	$('im').src = "http://www.plantuml.com/plantuml/img/" + encodeResult;
}

function compress(s) {

    //test
    console.log(s);

	//UTF8
	s = unescape(encodeURIComponent(s));

	console.log(s);

	if (deflater) {
		if (deflater.port && deflater.port.postMessage) {
			deflater.port.postMessage(s);
		} else {
			deflater.postMessage(s);
		}
  	} else {
 		setTimeout(function() {
	  		done_deflating({ data: deflate(s) });
		}, 100);
  	}
}

</script>
</html>



